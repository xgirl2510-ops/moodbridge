rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is participant in array
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }
    
    // Check if user is not banned
    function isNotBanned() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isBanned != true;
    }
    
    // Get today's date string (YYYY-MM-DD)
    function todayString() {
      return request.time.toDate().format('yyyy-MM-dd');
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
      // Anyone authenticated can read basic user info (for display)
      allow read: if isAuthenticated();
      
      // Only owner can create their own profile
      allow create: if isOwner(userId) && 
        request.resource.data.uid == userId &&
        request.resource.data.isBanned == false &&
        request.resource.data.isActive == true;
      
      // Only owner can update their profile (except ban status)
      allow update: if isOwner(userId) && 
        request.resource.data.isBanned == resource.data.isBanned &&
        request.resource.data.uid == resource.data.uid;
      
      // No delete allowed (soft delete via isActive)
      allow delete: if false;
      
      // User stats subcollection
      match /stats/{statId} {
        allow read: if isOwner(userId);
        // Only Cloud Functions can write stats
        allow write: if false;
      }
    }
    
    // ============================================
    // CHECKINS COLLECTION
    // ============================================
    
    match /checkins/{checkinId} {
      // Users can read their own checkins
      // Happy users can read sad checkins (for matching)
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.mood == 'sad' && resource.data.wantsEncouragement == true)
      );
      
      // Users can create their own checkin
      allow create: if isAuthenticated() && isNotBanned() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.mood in ['happy', 'sad'] &&
        request.resource.data.matchedCount == 0;
      
      // Users can update only wantsEncouragement field
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.userId == resource.data.userId &&
        request.resource.data.mood == resource.data.mood &&
        request.resource.data.date == resource.data.date;
      
      allow delete: if false;
    }
    
    // ============================================
    // ENCOURAGEMENTS COLLECTION
    // ============================================
    
    match /encouragements/{encouragementId} {
      // Sender and receiver can read
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      
      // Authenticated users can send (with validations)
      allow create: if isAuthenticated() && isNotBanned() &&
        request.resource.data.senderId == request.auth.uid &&
        request.resource.data.receiverId != request.auth.uid &&
        request.resource.data.isRead == false &&
        request.resource.data.reaction == null &&
        request.resource.data.messageType in ['text', 'template', 'voice', 'sticker'];
      
      // Receiver can update reaction and isRead
      allow update: if isOwner(resource.data.receiverId) &&
        request.resource.data.senderId == resource.data.senderId &&
        request.resource.data.receiverId == resource.data.receiverId &&
        request.resource.data.content == resource.data.content &&
        (request.resource.data.reaction == null || 
         request.resource.data.reaction in ['thanks', 'feeling_better', 'want_to_chat']);
      
      allow delete: if false;
    }
    
    // ============================================
    // CONNECTIONS COLLECTION
    // ============================================
    
    match /connections/{connectionId} {
      // Participants can read
      allow read: if isParticipant(resource.data.participants);
      
      // Users can create connection requests
      allow create: if isAuthenticated() && isNotBanned() &&
        request.resource.data.requesterId == request.auth.uid &&
        request.resource.data.receiverId != request.auth.uid &&
        request.resource.data.status == 'pending' &&
        request.auth.uid in request.resource.data.participants;
      
      // Receiver can accept/reject, either can block
      allow update: if isParticipant(resource.data.participants) &&
        request.resource.data.requesterId == resource.data.requesterId &&
        request.resource.data.receiverId == resource.data.receiverId &&
        request.resource.data.participants == resource.data.participants &&
        request.resource.data.status in ['pending', 'accepted', 'rejected', 'blocked'];
      
      allow delete: if false;
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    
    match /chats/{chatId} {
      // Participants can read chat metadata
      allow read: if isParticipant(resource.data.participants);
      
      // Only Cloud Functions create chats
      allow create: if false;
      
      // Participants can update (last message, unread count)
      allow update: if isParticipant(resource.data.participants) &&
        request.resource.data.participants == resource.data.participants &&
        request.resource.data.connectionId == resource.data.connectionId;
      
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isParticipant(
          get(/databases/$(database)/documents/chats/$(chatId)).data.participants
        );
        
        // Participants can send messages
        allow create: if isAuthenticated() && isNotBanned() &&
          isParticipant(
            get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          ) &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.isRead == false;
        
        // Receiver can mark as read
        allow update: if isAuthenticated() &&
          isParticipant(
            get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          ) &&
          resource.data.senderId != request.auth.uid &&
          request.resource.data.senderId == resource.data.senderId &&
          request.resource.data.content == resource.data.content;
        
        allow delete: if false;
      }
    }
    
    // ============================================
    // TEMPLATES COLLECTION (Read-only)
    // ============================================
    
    match /templates/{templateId} {
      // Anyone authenticated can read templates
      allow read: if isAuthenticated();
      
      // Only admins can write (via Firebase Console or Cloud Functions)
      allow write: if false;
    }
    
    // ============================================
    // REPORTS COLLECTION
    // ============================================
    
    match /reports/{reportId} {
      // Users can read their own reports
      allow read: if isAuthenticated() && 
        resource.data.reporterId == request.auth.uid;
      
      // Users can create reports
      allow create: if isAuthenticated() &&
        request.resource.data.reporterId == request.auth.uid &&
        request.resource.data.status == 'pending' &&
        request.resource.data.reason in ['spam', 'harassment', 'inappropriate', 'other'];
      
      // No update/delete by users
      allow update: if false;
      allow delete: if false;
    }
  }
}
